<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Dual Cat Liner - Complete Edition</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #f0f4f8;
            font-family: 'Arial', sans-serif;
            display: flex;
            height: 100vh;
            user-select: none;
        }

        /* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #sidebar {
            width: 340px;
            background: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            box-shadow: 4px 0 15px rgba(0,0,0,0.2);
            z-index: 100;
            flex-shrink: 0;
        }

        h1 {
            color: #f39c12;
            font-size: 22px;
            margin: 0 0 10px 0;
            text-align: center;
            border-bottom: 2px solid #7f8c8d;
            padding-bottom: 10px;
        }

        /* ã‚¹ã‚³ã‚¢ãƒ»ãƒ¬ãƒ™ãƒ«è¡¨ç¤º */
        .status-bar {
            display: flex;
            justify-content: space-between;
            background: #34495e;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .status-item span { display: block; font-size: 12px; color: #bdc3c7; }
        .status-value { font-size: 18px; color: #2ecc71; }

        /* å…¥åŠ›ã‚¨ãƒªã‚¢ */
        .formula-card {
            background: #34495e;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #f39c12;
        }

        .equation-row {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
        }

        .fraction-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 6px;
        }
        
        input[type="number"] {
            width: 55px;
            height: 40px;
            font-size: 20px;
            text-align: center;
            border: 2px solid #95a5a6;
            border-radius: 5px;
            font-weight: bold;
            background: #ecf0f1;
            color: #2c3e50;
        }
        input[type="number"]:focus {
            border-color: #f39c12;
            outline: none;
            background: #fff;
        }

        .fraction-line {
            width: 100%;
            height: 2px;
            background: white;
            margin: 4px 0;
        }

        /* ãƒœã‚¿ãƒ³ç¾¤ */
        .btn-group { display: flex; gap: 10px; margin-top: 5px; }
        
        button {
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.1s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        button:active { transform: translateY(3px); box-shadow: none; }
        button:disabled { background: #7f8c8d !important; box-shadow: none; cursor: not-allowed; }

        #goBtn { background: #e74c3c; width: 100%; font-size: 18px; }
        #clearBtn { background: #95a5a6; width: 100%; margin-top: 10px; font-size: 14px;}

        /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
        #feedback {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            line-height: 1.4;
            min-height: 80px;
        }
        .coord-text { color: #f1c40f; font-size: 16px; font-family: monospace; }
        .success-msg { color: #2ecc71; font-size: 16px;}
        .fail-msg { color: #e74c3c; }

        .hint-box {
            margin-top: auto;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            text-align: center;
            color: #bdc3c7;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #game-container {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
            cursor: grab;
            background: #ffffff;
        }
        #game-container:active { cursor: grabbing; }

        /* UIã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #coord-display {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(44, 62, 80, 0.9);
            color: #ecf0f1;
            padding: 8px 15px;
            border-radius: 20px;
            font-family: monospace;
            font-size: 18px;
            pointer-events: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 50;
        }
        
        #center-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #34495e;
            width: auto;
            z-index: 50;
        }

        /* çµæœç”»é¢ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #result-modal {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .rank-big { font-size: 120px; font-weight: bold; color: #f1c40f; margin: 0; text-shadow: 0 0 20px orange; }
        .score-detail { font-size: 24px; margin-bottom: 30px; }
        .restart-btn { padding: 15px 40px; font-size: 24px; background: #2ecc71; }

    </style>
</head>
<body>

<div id="sidebar">
    <h1>Dual Cat Liner</h1>
    
    <div class="status-bar">
        <div class="status-item">
            <span>LEVEL</span>
            <div class="status-value" id="level-disp">1 / 10</div>
        </div>
        <div class="status-item">
            <span>SCORE</span>
            <div class="status-value" id="score-disp">0</div>
        </div>
    </div>
    
    <div class="formula-card">
        <div class="equation-row">
            <span>y = </span>
            <div class="fraction-group">
                <input type="number" id="slopeNum" value="1">
                <div class="fraction-line"></div>
                <input type="number" id="slopeDen" value="1">
            </div>
            <span>x + </span>
            <div class="fraction-group">
                <div style="height: 35px;"></div> <input type="number" id="intercept" value="0">
            </div>
        </div>
    </div>

    <button id="goBtn" onclick="launchCat()">ç™ºå°„ (Go)</button>
    <button id="clearBtn" onclick="clearLines()">ç·šã®ãƒªã‚»ãƒƒãƒˆ (Reset Lines)</button>

    <div id="feedback">æº–å‚™ä¸­...</div>
    
    <div class="hint-box">
        ğŸ–±ï¸ãƒ‰ãƒ©ãƒƒã‚°: ç§»å‹•<br>
        ğŸ¡ãƒ›ã‚¤ãƒ¼ãƒ«: ã‚ºãƒ¼ãƒ <br>
        é–“é•ã£ãŸç·šã¯æ®‹ã‚Šã¾ã™ï¼<br>ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã§æ¶ˆå»å¯èƒ½
    </div>
</div>

<div id="game-container">
    <canvas id="canvas"></canvas>
    <div id="coord-display">Mouse: (0, 0)</div>
    <button id="center-btn" onclick="resetCamera()">è¦–ç‚¹ã‚’æˆ»ã™</button>
    
    <div id="result-modal">
        <h1>ALL STAGES CLEAR!</h1>
        <div class="rank-big" id="final-rank">S</div>
        <div class="score-detail">Final Score: <span id="final-score">0</span> pts</div>
        <button class="restart-btn" onclick="location.reload()">Play Again</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('game-container');

    // --- ã‚²ãƒ¼ãƒ è¨­å®š ---
    let GRID_SIZE = 60; 
    const MAX_QUESTIONS = 10;
    
    // ãƒ“ãƒ¥ãƒ¼ç®¡ç†
    let originX, originY;
    let isDragging = false;
    let dragStartX, dragStartY;
    let initialOriginX, initialOriginY;

    // ã‚¹ãƒ†ãƒ¼ãƒˆç®¡ç†
    let currentLevel = 1;
    let totalScore = 0;
    let wrongAttempts = 0; // ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã§ã®ãƒŸã‚¹å›æ•°
    let gameState = 'playing'; // playing, animating, cleared, result

    // å•é¡Œãƒ‡ãƒ¼ã‚¿
    let targets = []; // {x, y, label, color}
    let trueLine = { num: 0, den: 1, b: 0 };
    
    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ‡ãƒ¼ã‚¿
    let lineHistory = []; // éå»ã®å¤±æ•—ã—ãŸç·š {num, den, b}
    let currentUserLine = null; // ç¾åœ¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®ç·š
    let isAnimating = false;
    let catX = 0;
    let hitStatus = [false, false];

    // ç´ æ
    const CHAR_CAT = "ğŸ±";
    const CHAR_FISH_A = "ğŸŸA";
    const CHAR_FISH_B = "ğŸ B";

    // --- åˆæœŸåŒ– ---
    function init() {
        resize();
        resetCamera();
        startLevel();
        setupEvents();
        draw();
    }

    function resetCamera() {
        originX = canvas.width / 2;
        originY = canvas.height / 2;
        GRID_SIZE = 60; // ã‚ºãƒ¼ãƒ ã‚‚ãƒªã‚»ãƒƒãƒˆ
        draw();
    }

    function startLevel() {
        // å¤‰æ•°ãƒªã‚»ãƒƒãƒˆ
        targets = [];
        lineHistory = [];
        currentUserLine = null;
        wrongAttempts = 0;
        isAnimating = false;
        
        updateUI();
        generateMission();
        
        // è¦–ç‚¹ã‚’å¼·åˆ¶çš„ã«æˆ»ã™ï¼ˆé­šã‚’è¦‹å¤±ã‚ãªã„ã‚ˆã†ã«ï¼‰
        resetCamera();
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    function setupEvents() {
        window.addEventListener('resize', () => { resize(); draw(); });

        // ãƒã‚¦ã‚¹ç§»å‹• & ãƒ‰ãƒ©ãƒƒã‚°
        canvas.addEventListener('mousemove', (e) => {
            updateMouseCoord(e.clientX, e.clientY);
            if (isDragging) {
                const dx = e.clientX - dragStartX;
                const dy = e.clientY - dragStartY;
                originX = initialOriginX + dx;
                originY = initialOriginY + dy;
                draw();
            }
        });

        container.addEventListener('mousedown', (e) => {
            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            initialOriginX = originX;
            initialOriginY = originY;
            container.style.cursor = "grabbing";
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            container.style.cursor = "grab";
        });

        // â˜…ãƒ›ã‚¤ãƒ¼ãƒ«ã‚ºãƒ¼ãƒ æ©Ÿèƒ½
        container.addEventListener('wheel', (e) => {
            e.preventDefault();
            const scaleAmount = -e.deltaY * 0.001;
            
            // ã‚ºãƒ¼ãƒ å‰ã®ãƒã‚¦ã‚¹ä½ç½®ã®æ•°å­¦åº§æ¨™ã‚’è¨ˆç®—ï¼ˆã“ã“ã‚’ä¸­å¿ƒã«ã‚ºãƒ¼ãƒ ã—ãŸã„ãŒç°¡æ˜“çš„ã«ä¸­å¤®ã‚ºãƒ¼ãƒ ã§ã‚‚å¯ï¼‰
            // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã«ç•™ã‚ã‚‹ï¼ˆä¸­å¿ƒã¯ãšã‚Œãªã„ï¼‰
            let newSize = GRID_SIZE + (GRID_SIZE * scaleAmount);
            newSize = Math.max(20, Math.min(newSize, 150)); // åˆ¶é™
            
            GRID_SIZE = newSize;
            draw();
        }, { passive: false });
    }

    function updateMouseCoord(cx, cy) {
        const rect = canvas.getBoundingClientRect();
        const mx = cx - rect.left;
        const my = cy - rect.top;
        const gx = Math.round((mx - originX) / GRID_SIZE);
        const gy = Math.round(-(my - originY) / GRID_SIZE);
        document.getElementById('coord-display').innerText = `Mouse: (${gx}, ${gy})`;
    }

    function resize() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
    }

    // --- å•é¡Œç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (æ”¹) ---
    function generateMission() {
        let points = [];
        let attempts = 0;

        // â˜…é‡è¦: é­šãŒè¦‹ãˆã‚‹ç¯„å›²ã«é™å®š (-8 ~ +8)
        const SAFE_RANGE = 8;

        while(points.length < 2 && attempts < 5000) {
            attempts++;
            points = [];
            
            // æ‰‹é †1: ã¾ãšæ•´æ•°åˆ‡ç‰‡ b ã‚’æ±ºã‚ã‚‹ (-5 ~ 5)
            const b = Math.floor(Math.random() * 11) - 5;

            // æ‰‹é †2: å‚¾ãã‚’æ±ºã‚ã‚‹ (åˆ†æ¯1~4, åˆ†å­-4~4)
            const den = Math.floor(Math.random() * 4) + 1;
            let num = Math.floor(Math.random() * 9) - 4;
            if (num === 0) num = 1; // å‚¾ã0ã¯ç°¡å˜ã™ãã‚‹ã®ã§é™¤å¤–

            trueLine = { num, den, b };

            // æ‰‹é †3: ã“ã®ç›´ç·šä¸Šã®æ•´æ•°åº§æ¨™ã‚’æ¢ã™ (SAFE_RANGEå†…)
            for (let x = -SAFE_RANGE; x <= SAFE_RANGE; x++) {
                // y = (num/den)x + b
                // num*x ãŒ den ã§å‰²ã‚Šåˆ‡ã‚Œã‚‹ã‹
                if ((num * x) % den === 0) {
                    const y = (num * x) / den + b;
                    // Yåº§æ¨™ã‚‚å®‰å…¨åœå†…ã‹
                    if (y >= -SAFE_RANGE/1.5 && y <= SAFE_RANGE/1.5) { // Yã¯å°‘ã—ç‹­ã
                        points.push({ x: x, y: y });
                    }
                }
            }

            // 2ç‚¹ä»¥ä¸Šè¦‹ã¤ã‹ã£ãŸã‹ã€ã‹ã¤è·é›¢ãŒè¿‘ã™ããªã„ã‹
            if (points.length >= 2) {
                points.sort(() => Math.random() - 0.5);
                const p1 = points[0];
                const p2 = points[1];

                if (Math.abs(p1.x - p2.x) > 2 || Math.abs(p1.y - p2.y) > 2) {
                    targets = [
                        { ...p1, label: CHAR_FISH_A, color: "#3498db" },
                        { ...p2, label: CHAR_FISH_B, color: "#e67e22" }
                    ];
                } else {
                    points = []; // è¿‘ã™ãã‚‹ã®ã§ã‚„ã‚Šç›´ã—
                }
            } else {
                points = [];
            }
        }

        // UIæ›´æ–°
        const ui = document.getElementById('feedback');
        ui.innerHTML = `
            ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåº§æ¨™<br>
            <span class="coord-text">${targets[0].label}: (${targets[0].x}, ${targets[0].y})</span><br>
            <span class="coord-text">${targets[1].label}: (${targets[1].x}, ${targets[1].y})</span>
        `;
        ui.className = "";
        
        document.getElementById('goBtn').disabled = false;
        document.getElementById('goBtn').innerText = "ç™ºå°„ (Go)";
    }

    // --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---

    // æ•°å­¦çš„åˆ¤å®š
    function checkMath(px, py, num, den, b) {
        // d*y = n*x + b*d
        return (den * py) === (num * px + b * den);
    }

    function launchCat() {
        const inNum = parseInt(document.getElementById('slopeNum').value);
        const inDen = parseInt(document.getElementById('slopeDen').value);
        const inB = parseInt(document.getElementById('intercept').value);

        if (isNaN(inNum) || isNaN(inDen) || isNaN(inB)) {
            alert("æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return;
        }
        if (inDen === 0) {
            alert("åˆ†æ¯ã¯0ã«ã§ãã¾ã›ã‚“"); return;
        }

        currentUserLine = { num: inNum, den: inDen, b: inB };
        
        // æ­£è§£åˆ¤å®š
        hitStatus = [
            checkMath(targets[0].x, targets[0].y, inNum, inDen, inB),
            checkMath(targets[1].x, targets[1].y, inNum, inDen, inB)
        ];

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        isAnimating = true;
        // ç”»é¢å·¦ç«¯ç›¸å½“ã®Xã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
        catX = Math.floor(-originX / GRID_SIZE) - 5; 
        
        document.getElementById('goBtn').disabled = true;
        animate();
    }

    function animate() {
        if (!isAnimating) return;
        catX += 0.3; // é€Ÿåº¦
        draw();

        // ç”»é¢å³ç«¯ç›¸å½“
        const endX = Math.floor((canvas.width - originX) / GRID_SIZE) + 5;
        
        if (catX > endX) {
            finishAnimation();
        } else {
            requestAnimationFrame(animate);
        }
    }

    function finishAnimation() {
        isAnimating = false;
        const ui = document.getElementById('feedback');
        const btn = document.getElementById('goBtn');

        if (hitStatus[0] && hitStatus[1]) {
            // æ­£è§£ï¼
            const earned = Math.max(100, 1000 - (wrongAttempts * 200)); // æœ€ä½100ç‚¹
            totalScore += earned;
            
            ui.innerHTML = `<span class='success-msg'>Level Clear!</span><br>+${earned} pts`;
            ctx.fillStyle = "rgba(46, 204, 113, 0.2)";
            ctx.fillRect(0,0,canvas.width, canvas.height);

            btn.innerText = "æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¸ (Next)";
            btn.disabled = false;
            btn.onclick = function() {
                this.onclick = launchCat; // ãƒãƒ³ãƒ‰ãƒ©æˆ»ã™
                nextLevel();
            };

        } else {
            // ä¸æ­£è§£
            wrongAttempts++;
            lineHistory.push(currentUserLine); // å±¥æ­´ã«è¿½åŠ 
            
            let msg = "<span class='fail-msg'>Miss!</span><br>";
            if (hitStatus[0] || hitStatus[1]) msg += "ç‰‡æ–¹ã—ã‹é€šã£ã¦ã„ã¾ã›ã‚“ã€‚<br>";
            else msg += "ä¸¡æ–¹å¤–ã‚Œã¦ã„ã¾ã™ã€‚<br>";
            msg += `(ãƒŸã‚¹å›æ•°: ${wrongAttempts})`;

            ui.innerHTML = msg;
            btn.innerText = "ã‚‚ã†ä¸€åº¦ (Retry)";
            btn.disabled = false;
            draw(); // ã‚°ãƒ¬ãƒ¼ã®ç·šã‚’æç”»ã™ã‚‹ãŸã‚ã«æ›´æ–°
        }
        updateUI();
    }

    function nextLevel() {
        currentLevel++;
        if (currentLevel > MAX_QUESTIONS) {
            showResult();
        } else {
            startLevel();
        }
    }

    function clearLines() {
        lineHistory = [];
        draw();
    }

    function showResult() {
        const modal = document.getElementById('result-modal');
        const rankEl = document.getElementById('final-rank');
        const scoreEl = document.getElementById('final-score');

        // ãƒ©ãƒ³ã‚¯åˆ¤å®š
        let rank = "F";
        if (totalScore >= 9000) rank = "S";
        else if (totalScore >= 8000) rank = "A";
        else if (totalScore >= 6000) rank = "B";
        else if (totalScore >= 4000) rank = "C";
        else rank = "D";

        rankEl.innerText = rank;
        scoreEl.innerText = totalScore;
        
        if(rank === "S") rankEl.style.color = "#f1c40f"; // Gold
        else if(rank === "A") rankEl.style.color = "#e91e63"; // Pink
        else if(rank === "B") rankEl.style.color = "#3498db"; // Blue
        
        modal.style.display = "flex";
    }

    function updateUI() {
        document.getElementById('level-disp').innerText = `${currentLevel} / ${MAX_QUESTIONS}`;
        document.getElementById('score-disp').innerText = totalScore;
    }

    // --- æç”» ---
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawGrid();
        drawTargets();
        
        // éå»ã®å¤±æ•—ç·š
        lineHistory.forEach(line => {
            drawLine(line, "#bdc3c7", 2); // ã‚°ãƒ¬ãƒ¼ã®ç·š
        });

        // ç¾åœ¨ã®ç·šï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®ã¿çŒ«ã€ãã‚Œä»¥å¤–ã¯ç·šã ã‘è¡¨ç¤ºã—ã¦ã‚‚ã‚ˆã„ãŒã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã ã‘æãï¼‰
        if (isAnimating && currentUserLine) {
            drawLine(currentUserLine, "#e74c3c", 4);
            drawCat();
        }
    }

    function drawLine(line, color, width) {
        const slope = line.num / line.den;
        const b = line.b;
        
        // ç”»é¢ã«è¦‹ãˆã¦ã„ã‚‹ç¯„å›²
        const minX = (0 - originX) / GRID_SIZE;
        const maxX = (canvas.width - originX) / GRID_SIZE;

        const y1 = slope * minX + b;
        const y2 = slope * maxX + b;

        const p1y = originY - y1 * GRID_SIZE;
        const p2y = originY - y2 * GRID_SIZE;

        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = width;
        ctx.moveTo(0, p1y);
        ctx.lineTo(canvas.width, p2y);
        ctx.stroke();
    }

    function drawGrid() {
        ctx.lineWidth = 1;
        ctx.font = "14px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        const startX = Math.floor(-originX / GRID_SIZE) - 1;
        const endX = Math.floor((canvas.width - originX) / GRID_SIZE) + 1;
        const startY = Math.floor(-(canvas.height - originY) / GRID_SIZE) - 1;
        const endY = Math.floor(originY / GRID_SIZE) + 1;

        // è»¸
        ctx.strokeStyle = "#34495e";
        ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(0, originY); ctx.lineTo(canvas.width, originY); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(originX, 0); ctx.lineTo(originX, canvas.height); ctx.stroke();

        // ã‚°ãƒªãƒƒãƒ‰
        for (let i = startX; i <= endX; i++) {
            const x = originX + i * GRID_SIZE;
            ctx.strokeStyle = (i === 0) ? "transparent" : "rgba(0,0,0,0.1)";
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
            if (i !== 0) {
                ctx.fillStyle = "#7f8c8d";
                ctx.fillText(i, x, originY + 20);
            }
        }

        for (let i = startY; i <= endY; i++) {
            const y = originY - i * GRID_SIZE;
            ctx.strokeStyle = (i === 0) ? "transparent" : "rgba(0,0,0,0.1)";
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
            if (i !== 0) {
                ctx.fillStyle = "#7f8c8d";
                ctx.fillText(i, originX - 20, y);
            }
        }
        
        ctx.fillStyle = "#34495e";
        ctx.font = "bold 16px Arial";
        ctx.fillText("O", originX - 20, originY + 20);
    }

    function drawTargets() {
        targets.forEach(t => {
            const tx = originX + t.x * GRID_SIZE;
            const ty = originY - t.y * GRID_SIZE;

            ctx.fillStyle = t.color;
            ctx.beginPath();
            ctx.arc(tx, ty, 8, 0, Math.PI*2);
            ctx.fill();

            ctx.font = "28px Arial";
            ctx.textAlign = "center";
            ctx.fillText(t.label.substring(0, 2), tx, ty - 25);
            
            ctx.font = "bold 16px Arial";
            ctx.fillStyle = "#333";
            ctx.fillText(t.label.substring(2), tx + 15, ty + 5);
        });
    }

    function drawCat() {
        const slope = currentUserLine.num / currentUserLine.den;
        const cyMath = slope * catX + currentUserLine.b;

        const cx = originX + catX * GRID_SIZE;
        const cy = originY - cyMath * GRID_SIZE;

        ctx.font = "40px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(CHAR_CAT, cx, cy);
    }

    // é–‹å§‹
    init();

</script>
</body>
</html>
